customElements.get("product-recommendations")||customElements.define("product-recommendations",class extends HTMLElement{constructor(){super(),this.productHandle=this.dataset.productHandle,this.productId=this.dataset.productId,this.collectionHandle=this.dataset.collectionHandle,this.productTags=this.dataset.productTags?this.dataset.productTags.split(",").map(t=>t.trim()):[],this.minProducts=parseInt(this.dataset.minProducts)||4,this.maxProducts=parseInt(this.dataset.maxProducts)||8,this.hideSoldOut="true"===this.dataset.hideSoldOut,this.sectionId=this.dataset.sectionId,this.container=this.querySelector("[data-product-container]"),this.loading=this.querySelector("[data-loading]")}async connectedCallback(){if(console.log("product-recommendations: Initializing",{productId:this.productId,productHandle:this.productHandle,collectionHandle:this.collectionHandle,tags:this.productTags,min:this.minProducts,max:this.maxProducts,hideSoldOut:this.hideSoldOut,hasContainer:!!this.container}),this.productId&&this.container)try{const t=await this.fetchProducts();console.log("product-recommendations: Fetched products",t),await this.renderProducts(t)}catch(t){console.error("product-recommendations: Error fetching products",t),this.hideLoading()}else console.error("product-recommendations: Missing required elements or data attributes",{productId:this.productId,container:this.container})}async fetchProducts(){let t=[];try{t=[...await this.fetchRecommendations()],console.log("product-recommendations: Step 1 (Recommendations API):",t.length,"products")}catch(t){console.warn("product-recommendations: Recommendations API failed",t)}if(t=this.filterProductsWithImages(t),this.hideSoldOut){const e=t.length;t=this.filterAvailableProducts(t),console.log(`product-recommendations: Filtered sold out: ${e} -> ${t.length}`)}if(t.length<this.minProducts&&this.collectionHandle)try{const e=await this.fetchCollectionProducts();let o=this.filterProductsWithImages(e);this.hideSoldOut&&(o=this.filterAvailableProducts(o)),console.log("product-recommendations: Step 2 (Collection):",o.length,"products"),t=this.mergeProducts(t,o),console.log("product-recommendations: After merge:",t.length,"products")}catch(t){console.warn("product-recommendations: Collection fetch failed",t)}if(t.length<this.minProducts&&this.productTags.length>0)try{const e=await this.fetchTaggedProducts();let o=this.filterProductsWithImages(e);this.hideSoldOut&&(o=this.filterAvailableProducts(o)),console.log("product-recommendations: Step 3 (Tagged):",o.length,"products"),t=this.mergeProducts(t,o),console.log("product-recommendations: After merge:",t.length,"products")}catch(t){console.warn("product-recommendations: Tagged products fetch failed",t)}if(t.length<this.minProducts){console.log(`product-recommendations: Step 4 (Random) - need ${this.minProducts-t.length} more products`);try{const e=await this.fetchRandomProducts();let o=this.filterProductsWithImages(e);this.hideSoldOut&&(o=this.filterAvailableProducts(o)),console.log("product-recommendations: Step 4 (Random):",o.length,"products"),t=this.mergeProducts(t,o),console.log("product-recommendations: After merge:",t.length,"products")}catch(t){console.warn("product-recommendations: Random products fetch failed",t)}}return console.log("product-recommendations: Final product count:",t.length),this.shuffleArray(t).slice(0,this.maxProducts)}async fetchRecommendations(){const t=this.hideSoldOut?Math.max(3*this.maxProducts,20):this.maxProducts,e=await fetch(`/recommendations/products.json?product_id=${this.productId}&limit=${t}`);if(!e.ok)throw new Error("Recommendations API request failed");const o=await e.json();return this.filterCurrentProduct(o.products||[])}async fetchCollectionProducts(){const t=await fetch(`/collections/${this.collectionHandle}/products.json?limit=250`);if(!t.ok)throw new Error("Collection products request failed");const e=await t.json();return this.filterCurrentProduct(e.products||[])}async fetchTaggedProducts(){const t=await fetch("/collections/all/products.json?limit=250");if(!t.ok)throw new Error("Tagged products request failed");const e=((await t.json()).products||[]).filter(t=>this.productTags.some(e=>t.tags.includes(e)));return this.filterCurrentProduct(e)}async fetchRandomProducts(){const t=await fetch("/collections/all/products.json?limit=250");if(!t.ok)throw new Error("Random products request failed");const e=await t.json();console.log("product-recommendations: Random fetch raw:",e.products?.length||0,"products");const o=this.shuffleArray(e.products||[]),r=this.filterCurrentProduct(o);return console.log("product-recommendations: Random after filtering current product:",r.length,"products"),r}filterCurrentProduct(t){return t.filter(t=>t.id.toString()!==this.productId&&t.handle!==this.productHandle)}filterAvailableProducts(t){const e=t.filter(t=>"boolean"==typeof t.available?t.available:!(t.variants&&t.variants.length>0)||t.variants.some(t=>!0===t.available));return console.log(`product-recommendations: filterAvailableProducts: ${t.length} -> ${e.length}`),e}filterProductsWithImages(t){const e=t.filter(t=>{if(t.featured_image&&"string"==typeof t.featured_image&&t.featured_image.length>0)return!0;if(t.images&&Array.isArray(t.images)&&t.images.length>0){const e=t.images[0];if("string"==typeof e&&e.length>0)return!0;if(e&&"object"==typeof e&&e.src&&e.src.length>0)return!0}return!1}),o=t.length-e.length;return o>0&&console.log(`product-recommendations: filterProductsWithImages: ${t.length} -> ${e.length} (filtered ${o} products without images)`),e}mergeProducts(t,e){const o=new Set(t.map(t=>t.id)),r=e.filter(t=>!o.has(t.id));return[...t,...r]}shuffleArray(t){const e=[...t];for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}async renderProducts(t){if(console.log("product-recommendations: Rendering",t.length,"products"),0===t.length)return console.log("product-recommendations: No products to render"),this.hideLoading(),void(this.style.display="none");this.container.innerHTML="";try{const e=t.map(t=>fetch(`/products/${t.handle}?view=card`).then(e=>e.ok?e.text():(console.warn(`Failed to fetch card for ${t.handle}`),"")).catch(e=>(console.warn(`Error fetching card for ${t.handle}:`,e),""))),o=await Promise.all(e);this.container.innerHTML=o.filter(t=>t).join(""),console.log("product-recommendations: Rendered",this.container.children.length,"product cards")}catch(t){console.error("product-recommendations: Failed to render cards",t)}this.hideLoading()}hideLoading(){this.loading&&(this.loading.style.display="none")}});